<template>
  <div class="china-map-container">
    <div v-if="loading" class="map-loading">
      <div class="loading-spinner"></div>
      <p>{{ loadingText }}</p>
    </div>
    <div v-show="!loading" ref="chartDom" class="chart"></div>
    <div class="map-legend" v-if="!loading">
      <div class="legend-item">
        <span class="legend-dot visited"></span>
        <span>已去过</span>
      </div>
      <div class="legend-item">
        <span class="legend-dot active"></span>
        <span>当前选中</span>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, watch, onMounted, onUnmounted, nextTick } from "vue";
import * as echarts from "echarts";

// 城市坐标数据
const cityCoordinates: Record<string, [number, number]> = {
  北京: [116.407396, 39.9042],
  天津: [117.4163641, 39.3032619],
  上海: [121.4700152, 31.2312707],
  重庆: [107.8748712, 30.05518],
  石家庄: [114.5088385, 38.0429742],
  唐山: [118.1753934, 39.6351138],
  秦皇岛: [119.6004921, 39.9353776],
  邯郸: [114.4906858, 36.6122735],
  邢台: [114.4995001, 37.068204],
  保定: [115.464806, 38.874434],
  张家口: [114.8853001, 40.811901],
  承德: [117.962411, 40.954786],
  沧州: [116.838834, 38.304477],
  廊坊: [116.683752, 39.53775],
  衡水: [115.670177, 37.73892],
  太原: [112.5437075, 37.8699921],
  大同: [113.300126, 40.076816],
  阳泉: [113.580519, 37.856971],
  长治: [113.116255, 36.195386],
  晋城: [112.851831, 35.490701],
  朔州: [112.431519, 39.331261],
  晋中: [112.752694, 37.687024],
  运城: [110.997787, 35.026412],
  忻州: [112.734174, 38.416663],
  临汾: [111.518976, 36.088005],
  吕梁: [111.141647, 37.518314],
  呼和浩特: [111.6601939, 40.8184528],
  包头: [109.840405, 40.658168],
  乌海: [106.795841, 39.653836],
  赤峰: [118.886856, 42.257817],
  通辽: [122.244419, 43.652969],
  鄂尔多斯: [109.781327, 39.608266],
  呼伦贝尔: [119.765744, 49.211574],
  巴彦淖尔: [107.387657, 40.743213],
  乌兰察布: [113.114543, 40.993912],
  兴安盟: [122.070317, 46.076268],
  锡林郭勒盟: [116.091903, 43.944018],
  阿拉善盟: [105.706422, 38.844814],
  沈阳: [123.4279105, 41.8026095],
  大连: [122.255833, 39.740278],
  鞍山: [122.994329, 41.107994],
  抚顺: [123.957208, 41.880872],
  本溪: [123.685616, 41.488645],
  丹东: [124.383044, 40.124296],
  锦州: [121.135742, 41.119269],
  营口: [122.235417, 40.667012],
  阜新: [121.670325, 42.021619],
  辽阳: [123.236944, 41.268335],
  盘锦: [122.070714, 41.119997],
  铁岭: [123.726166, 42.223769],
  朝阳: [120.450372, 41.573734],
  葫芦岛: [120.836932, 40.711052],
  长春: [125.3180998, 43.8844201],
  吉林: [126.55302, 43.843577],
  四平: [124.350398, 43.16642],
  辽源: [125.145164, 42.88805],
  通化: [125.936501, 41.721177],
  白山: [126.427839, 41.940797],
  松原: [124.825117, 45.141502],
  白城: [122.838714, 45.619026],
  延边朝鲜族自治州: [129.509126, 42.904823],
  哈尔滨: [126.6276177, 45.7593633],
  齐齐哈尔: [123.917962, 47.354348],
  鸡西: [130.969333, 45.295075],
  鹤岗: [130.297964, 47.349916],
  双鸭山: [131.159134, 46.646064],
  大庆: [125.103784, 46.589309],
  伊春: [128.840806, 47.727536],
  佳木斯: [130.318917, 46.799327],
  七台河: [131.003067, 45.771266],
  牡丹江: [129.618602, 44.582962],
  黑河: [127.52856, 50.245329],
  绥化: [126.968887, 46.653262],
  大兴安岭地区: [124.711526, 52.335262],
  南京: [118.7788631, 32.0438284],
  无锡: [120.2952752, 31.5776626],
  徐州: [117.284124, 34.205768],
  常州: [119.973987, 31.810689],
  苏州: [120.6212881, 31.311123],
  南通: [120.894291, 31.980171],
  连云港: [119.221611, 34.596653],
  淮安: [119.015285, 33.610353],
  盐城: [120.161641, 33.349508],
  扬州: [119.412966, 32.39421],
  镇江: [119.452753, 32.204402],
  泰州: [119.915176, 32.484882],
  宿迁: [118.275198, 33.963008],
  杭州: [120.2052342, 30.2489634],
  宁波: [121.6203873, 29.8622194],
  温州: [120.699366, 27.994267],
  嘉兴: [120.755486, 30.746129],
  湖州: [120.086823, 30.894348],
  绍兴: [120.580232, 30.029752],
  金华: [119.647444, 29.079059],
  衢州: [118.874191, 28.935822],
  舟山: [122.207216, 29.985295],
  台州: [121.420757, 28.656386],
  丽水: [119.922796, 28.46763],
  合肥: [117.281428, 31.8665676],
  芜湖: [118.432941, 31.352859],
  蚌埠: [117.388312, 32.916287],
  淮南: [116.999932, 32.625478],
  马鞍山: [118.506759, 31.670452],
  淮北: [116.798265, 33.954797],
  铜陵: [117.812079, 30.945515],
  安庆: [117.063754, 30.54294],
  黄山: [118.337481, 29.714699],
  滁州: [118.316833, 32.301556],
  阜阳: [115.814504, 32.889632],
  宿州: [116.964356, 33.646373],
  六安: [116.521854, 31.7337],
  亳州: [115.778676, 33.844582],
  池州: [117.491568, 30.6648],
  宣城: [118.758816, 30.940718],
  福州: [119.2918215, 26.0774954],
  厦门: [118.0768065, 24.5438732],
  莆田: [119.007777, 25.454084],
  三明: [117.638678, 26.263849],
  泉州: [118.675675, 24.874132],
  漳州: [117.647093, 24.512948],
  南平: [118.17783, 26.641768],
  龙岩: [117.017536, 25.075123],
  宁德: [119.547932, 26.665617],
  南昌: [116.0348483, 28.6472124],
  景德镇: [117.178419, 29.268835],
  萍乡: [113.854556, 27.622768],
  九江: [116.00193, 29.705077],
  新余: [114.917346, 27.817808],
  鹰潭: [117.069202, 28.260189],
  赣州: [114.93503, 25.831829],
  吉安: [114.992039, 27.113848],
  宜春: [114.416778, 27.814864],
  抚州: [116.358181, 27.947811],
  上饶: [117.943433, 28.454863],
  济南: [117.1138479, 36.6519754],
  青岛: [120.3777659, 36.0663249],
  淄博: [118.054927, 36.813487],
  枣庄: [117.323725, 34.810487],
  东营: [118.674767, 37.433654],
  烟台: [121.447935, 37.463822],
  潍坊: [119.161756, 36.706962],
  济宁: [116.587245, 35.414129],
  泰安: [117.087614, 36.200252],
  威海: [122.120419, 37.513068],
  日照: [119.526888, 35.416734],
  临沂: [118.356414, 35.104673],
  德州: [116.357466, 37.434092],
  聊城: [115.98546, 36.457595],
  滨州: [118.017938, 37.383542],
  菏泽: [115.480656, 35.23375],
  郑州: [113.619321, 34.7472531],
  开封: [114.307581, 34.797049],
  洛阳: [112.45404, 34.619683],
  平顶山: [113.192661, 33.766169],
  安阳: [114.392392, 36.097577],
  鹤壁: [114.29777, 35.747225],
  新乡: [113.9268, 35.30323],
  焦作: [113.241823, 35.215631],
  濮阳: [115.029215, 35.761829],
  许昌: [113.852454, 34.035771],
  漯河: [114.016539, 33.581412],
  三门峡: [111.200135, 34.772611],
  南阳: [112.528321, 32.990664],
  商丘: [115.65637, 34.414172],
  信阳: [114.091023, 32.147679],
  周口: [114.650661, 33.620357],
  驻马店: [114.022298, 32.980169],
  武汉: [114.2999353, 30.5951051],
  黄石: [115.038867, 30.199653],
  十堰: [110.787916, 32.646907],
  宜昌: [111.286471, 30.691967],
  襄阳: [112.122415, 32.008986],
  鄂州: [114.894843, 30.39194],
  荆门: [112.199265, 31.035423],
  孝感: [113.916903, 30.924568],
  荆州: [112.239741, 30.335165],
  黄冈: [114.872316, 30.453667],
  咸宁: [114.322452, 29.841443],
  随州: [113.37377, 31.69013],
  恩施土家族苗族自治州: [109.488172, 30.272156],
  长沙: [113.2384362, 28.1450774],
  株洲: [113.13396, 27.827433],
  湘潭: [112.944052, 27.829738],
  衡阳: [112.571997, 26.893368],
  邵阳: [111.467791, 27.238893],
  岳阳: [113.129192, 29.357104],
  常德: [111.698497, 29.031673],
  张家界: [110.479191, 29.117096],
  益阳: [112.355042, 28.55386],
  郴州: [113.014737, 25.770509],
  永州: [111.613445, 26.420394],
  怀化: [109.998488, 27.554978],
  娄底: [111.994396, 27.697279],
  湘西土家族苗族自治州: [109.739735, 28.311949],
  广州: [113.2592945, 23.1301964],
  韶关: [113.597522, 24.810403],
  深圳: [114.0545429, 22.5445741],
  珠海: [113.5721327, 22.273734],
  汕头: [116.681972, 23.354091],
  佛山: [113.1159558, 23.0239788],
  江门: [113.081508, 22.578738],
  湛江: [110.359377, 21.270707],
  茂名: [110.925456, 21.662999],
  肇庆: [112.465091, 23.046237],
  惠州: [114.415801, 23.111847],
  梅州: [116.122238, 24.288615],
  汕尾: [115.375279, 22.78566],
  河源: [114.700447, 23.743686],
  阳江: [111.982232, 21.857958],
  清远: [113.056031, 23.681764],
  东莞: [113.7452332, 23.0183568],
  中山: [113.392782, 22.517],
  潮州: [116.622603, 23.656951],
  揭阳: [116.372831, 23.549993],
  云浮: [112.044439, 22.915094],
  南宁: [108.3627211, 22.8193063],
  柳州: [109.428081, 24.365219],
  桂林: [110.289879, 25.234225],
  梧州: [111.297604, 23.485131],
  北海: [109.119254, 21.473343],
  防城港: [108.354788, 21.614631],
  钦州: [108.654445, 21.957013],
  贵港: [109.60204, 23.0936],
  玉林: [110.150683, 22.63136],
  百色: [106.6003, 23.902437],
  贺州: [111.566694, 24.403582],
  河池: [108.062105, 24.695899],
  来宾: [109.221465, 23.733766],
  崇左: [107.364962, 22.378253],
  海口: [110.1956502, 20.0462328],
  三亚: [109.5034392, 18.2534658],
  三沙: [112.3387, 16.831839],
  儋州: [109.580811, 19.520932],
  成都: [104.063315, 30.659867],
  自贡: [104.778442, 29.33903],
  攀枝花: [101.718637, 26.582347],
  泸州: [105.442258, 28.871811],
  德阳: [104.397894, 31.126855],
  绵阳: [104.679114, 31.46751],
  广元: [105.843357, 32.435435],
  遂宁: [105.592898, 30.532847],
  内江: [105.058433, 29.580228],
  乐山: [103.765568, 29.552106],
  南充: [106.110698, 30.837793],
  眉山: [103.848538, 30.07563],
  宜宾: [104.630825, 28.755585],
  广安: [106.633212, 30.455961],
  达州: [107.46791, 31.209571],
  雅安: [102.984373, 29.987722],
  巴中: [106.747477, 31.867903],
  资阳: [104.627636, 30.128901],
  阿坝藏族羌族自治州: [102.224653, 31.899413],
  甘孜藏族自治州: [101.963815, 30.050663],
  凉山彝族自治州: [102.267335, 27.881611],
  贵阳: [106.6246178, 26.6499922],
  六盘水: [104.83023, 26.593343],
  遵义: [106.927389, 27.725654],
  安顺: [105.947594, 26.253072],
  毕节: [105.28501, 27.301693],
  铜仁: [109.191555, 27.718346],
  黔西南布依族苗族自治州: [104.906397, 25.08812],
  黔东南苗族侗族自治州: [107.982879, 26.583352],
  黔南布依族苗族自治州: [107.522098, 26.258205],
  昆明: [102.7086139, 25.0363006],
  曲靖: [103.796167, 25.489999],
  玉溪: [102.546543, 24.351928],
  保山: [99.161761, 25.112046],
  昭通: [103.716616, 27.338257],
  丽江: [100.22775, 26.855047],
  普洱: [100.966559, 22.825065],
  临沧: [100.088843, 23.886567],
  楚雄彝族自治州: [101.546046, 25.042165],
  红河哈尼族彝族自治州: [103.384182, 23.366843],
  文山壮族苗族自治州: [104.24401, 23.36951],
  西双版纳傣族自治州: [100.797941, 22.001724],
  大理白族自治州: [100.267638, 25.606486],
  德宏傣族景颇族自治州: [98.584895, 24.43232],
  怒江傈僳族自治州: [98.854304, 25.850949],
  迪庆藏族自治州: [99.706463, 27.826853],
  拉萨: [91.1173015, 29.6542054],
  日喀则: [88.880583, 29.267519],
  昌都: [97.178452, 31.136875],
  林芝: [94.362348, 29.654693],
  山南: [91.766529, 29.236023],
  那曲: [92.060214, 31.476004],
  阿里地区: [80.105498, 32.503187],
  西安: [108.9423363, 34.261004],
  铜川: [108.945233, 34.896756],
  宝鸡: [107.237974, 34.361979],
  咸阳: [108.708991, 34.329605],
  渭南: [109.509786, 34.499995],
  延安: [109.489781, 36.585455],
  汉中: [107.023323, 33.06748],
  榆林: [109.734589, 38.285198],
  安康: [109.029022, 32.684714],
  商洛: [109.940477, 33.870422],
  兰州: [103.733224, 36.474436],
  嘉峪关: [98.289152, 39.77313],
  金昌: [102.187888, 38.520089],
  白银: [104.137735, 36.544701],
  天水: [105.724947, 34.580863],
  武威: [102.63797, 37.9282],
  张掖: [100.449818, 38.925529],
  平凉: [106.665302, 35.543051],
  酒泉: [98.493714, 39.73255],
  庆阳: [107.642631, 35.709077],
  定西: [104.626282, 35.580662],
  陇南: [104.920221, 33.388598],
  临夏回族自治州: [103.210538, 35.601225],
  甘南藏族自治州: [102.911008, 34.986354],
  西宁: [101.440811, 36.824463],
  海东: [102.10327, 36.502916],
  海北藏族自治州: [100.901059, 36.959435],
  黄南藏族自治州: [102.019988, 35.517744],
  海南藏族自治州: [100.619542, 36.280353],
  果洛藏族自治州: [100.242143, 34.4736],
  玉树藏族自治州: [97.008522, 33.004049],
  海西蒙古族藏族自治州: [97.370785, 37.374663],
  银川: [106.2261926, 38.4852037],
  石嘴山: [106.383303, 38.984206],
  吴忠: [106.198793, 37.997461],
  固原: [106.24261, 36.015855],
  中卫: [105.196902, 37.500977],
  乌鲁木齐: [87.6139038, 43.8244074],
  克拉玛依: [84.889207, 45.579889],
  吐鲁番: [89.184078, 42.947613],
  哈密: [93.515075, 42.818501],
  昌吉回族自治州: [87.304012, 44.014577],
  博尔塔拉蒙古自治州: [82.074778, 44.903258],
  巴音郭楞蒙古自治州: [86.150969, 41.768552],
  阿克苏地区: [80.265068, 41.170712],
  克孜勒苏柯尔克孜自治州: [76.172825, 39.713431],
  喀什地区: [75.989138, 39.467664],
  和田地区: [79.922211, 37.110687],
  伊犁哈萨克自治州: [81.317946, 43.92186],
  塔城地区: [82.985732, 46.746301],
  阿勒泰地区: [88.13963, 47.848393],
  香港: [114.1628131, 22.2793278],
  澳门: [113.5380454, 22.1899448],
  台北: [121.5636796, 25.0375198],
  高雄: [120.3025796, 22.639838],
};

const props = defineProps<{
  activeCity?: string | null;
  visitedCities: string[];
  cityPhotoCounts?: Record<string, number>;
  showConnections?: boolean;
}>();

const emit = defineEmits<{
  (e: "select", city: string): void;
}>();

const chartDom = ref<HTMLElement | null>(null);
const loading = ref(true);
const loadingText = ref("加载地图中...");
let chartInstance: echarts.ECharts | null = null;

// 获取已访问城市的数据
const visitedCityData = computed(() => {
  return props.visitedCities
    .filter((city) => cityCoordinates[city])
    .map((city) => ({
      name: city,
      value: [
        ...(cityCoordinates[city] || [0, 0]),
        props.cityPhotoCounts?.[city] || 0,
      ],
    }));
});

// 获取当前选中城市的数据
const activeCityData = computed(() => {
  if (!props.activeCity || !cityCoordinates[props.activeCity]) return [];
  return [
    {
      name: props.activeCity,
      value: [
        ...(cityCoordinates[props.activeCity] || [0, 0]),
        props.cityPhotoCounts?.[props.activeCity] || 0,
      ],
    },
  ];
});

// 连接线数据
const connectionLines = computed(() => {
  if (!props.showConnections || props.visitedCities.length < 2) return [];

  const lines: Array<{ coords: [number, number][] }> = [];
  const visited = props.visitedCities.filter((city) => cityCoordinates[city]);

  for (let i = 0; i < visited.length - 1; i++) {
    const currentCity = visited[i];
    const nextCity = visited[i + 1];
    if (currentCity && nextCity) {
      const from = cityCoordinates[currentCity];
      const to = cityCoordinates[nextCity];
      if (from && to) {
        lines.push({ coords: [from, to] });
      }
    }
  }
  return lines;
});

// 图表配置
const getChartOption = () => ({
  backgroundColor: "transparent",
  tooltip: {
    trigger: "item",
    confine: true,
    formatter: (params: { name?: string; value?: number[] }) => {
      if (params.value && params.value[2] !== undefined) {
        return `<div style="font-weight: 600">${params.name}</div>
                <div style="color: #64748b; font-size: 12px">${params.value[2]} 张照片</div>`;
      }
      return params.name || "";
    },
    backgroundColor: "rgba(255, 255, 255, 0.95)",
    borderColor: "#e2e8f0",
    borderWidth: 1,
    padding: [8, 12],
    textStyle: {
      color: "#1e293b",
    },
  },
  geo: {
    map: "china",
    roam: true,
    zoom: 1.2,
    center: [105, 36],
    scaleLimit: {
      min: 0.8,
      max: 3,
    },
    itemStyle: {
      areaColor: "#f1f5f9",
      borderColor: "#cbd5e1",
      borderWidth: 1,
    },
    emphasis: {
      itemStyle: {
        areaColor: "#e2e8f0",
      },
      label: {
        show: false,
      },
    },
    select: {
      itemStyle: {
        areaColor: "#dbeafe",
      },
    },
    label: {
      show: false,
    },
  },
  series: [
    // 足迹连线
    {
      type: "lines",
      coordinateSystem: "geo",
      zlevel: 1,
      effect: {
        show: true,
        period: 6,
        trailLength: 0.3,
        symbol: "arrow",
        symbolSize: 5,
        color: "#3b82f6",
      },
      lineStyle: {
        color: "#93c5fd",
        width: 2,
        opacity: 0.6,
        curveness: 0.2,
      },
      data: connectionLines.value,
    },
    // 已访问城市
    {
      type: "effectScatter",
      coordinateSystem: "geo",
      zlevel: 2,
      rippleEffect: {
        brushType: "stroke",
        scale: 3,
        period: 4,
      },
      symbol: "circle",
      symbolSize: (val: number[]) => {
        const count = val[2] || 0;
        return Math.max(10, Math.min(20, 10 + count * 2));
      },
      itemStyle: {
        color: "#10b981",
        shadowBlur: 10,
        shadowColor: "rgba(16, 185, 129, 0.4)",
      },
      label: {
        show: true,
        formatter: "{b}",
        position: "right",
        distance: 8,
        align: "left",
        fontSize: 11,
        color: "#475569",
        fontWeight: 500,
      },
      data: visitedCityData.value,
    },
    // 当前选中城市
    {
      type: "effectScatter",
      coordinateSystem: "geo",
      zlevel: 3,
      rippleEffect: {
        brushType: "stroke",
        scale: 4,
        period: 3,
      },
      symbol: "circle",
      symbolSize: 18,
      itemStyle: {
        color: "#3b82f6",
        shadowBlur: 15,
        shadowColor: "rgba(59, 130, 246, 0.5)",
      },
      label: {
        show: true,
        formatter: "{b}",
        position: "top",
        fontSize: 12,
        color: "#3b82f6",
        fontWeight: 600,
      },
      data: activeCityData.value,
    },
  ],
});

// 加载中国地图 GeoJSON
const loadChinaMap = async (): Promise<boolean> => {
  try {
    console.log("[ChinaMap] 开始加载中国地图 GeoJSON...");
    loadingText.value = "正在获取地图数据...";

    // 使用本地文件，避免外部 API 的 CORS/403 问题
    const baseUrl = import.meta.env.BASE_URL || "/";
    const response = await fetch(`${baseUrl}data/china-geojson.json`);

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const geoJSON = await response.json();
    console.log(
      "[ChinaMap] GeoJSON 加载成功, 特征数量:",
      geoJSON.features?.length
    );

    loadingText.value = "正在注册地图...";
    echarts.registerMap("china", geoJSON);
    console.log("[ChinaMap] 地图注册成功");

    return true;
  } catch (error) {
    console.error("[ChinaMap] 加载地图失败:", error);
    loadingText.value = "地图加载失败，使用备用数据...";

    // 注册空地图作为备用
    echarts.registerMap("china", {
      type: "FeatureCollection",
      features: [],
    });

    return false;
  }
};

// 初始化图表
const initChart = async () => {
  console.log("[ChinaMap] 开始初始化图表...");

  // 1. 先加载地图数据
  await loadChinaMap();

  // 2. 等待 DOM 更新
  await nextTick();

  // 3. 确保 DOM 元素存在
  if (!chartDom.value) {
    console.error("[ChinaMap] 图表容器不存在");
    return;
  }

  // 4. 先隐藏加载状态，让图表容器可见
  loading.value = false;

  // 5. 等待 DOM 更新，确保容器可见
  await nextTick();

  console.log(
    "[ChinaMap] 图表容器尺寸:",
    chartDom.value.offsetWidth,
    "x",
    chartDom.value.offsetHeight
  );

  // 6. 初始化 ECharts 实例
  try {
    chartInstance = echarts.init(chartDom.value);
    console.log("[ChinaMap] ECharts 实例创建成功");

    // 7. 设置配置
    const option = getChartOption();
    console.log("[ChinaMap] 图表配置:", JSON.stringify(option.geo, null, 2));
    chartInstance.setOption(option);

    // 8. 绑定点击事件
    chartInstance.on("click", (params: any) => {
      if (
        params.componentType === "series" &&
        params.name &&
        props.visitedCities.includes(params.name)
      ) {
        emit("select", params.name);
      }
    });

    console.log("[ChinaMap] 图表初始化完成");
  } catch (error) {
    console.error("[ChinaMap] 图表初始化失败:", error);
  }
};

// 更新图表数据
const updateChart = () => {
  if (chartInstance) {
    chartInstance.setOption(getChartOption());
  }
};

// 监听数据变化更新图表
watch(
  () => [props.visitedCities, props.cityPhotoCounts, props.showConnections],
  () => {
    updateChart();
  },
  { deep: true }
);

// 监听 activeCity 变化，更新地图视图
watch(
  () => props.activeCity,
  (city) => {
    if (!chartInstance) return;

    // 更新选中城市的数据
    updateChart();

    // 如果有选中城市，平移到该城市
    if (city && cityCoordinates[city]) {
      chartInstance.setOption({
        geo: {
          center: cityCoordinates[city],
          zoom: 2,
        },
      });
    }
  }
);

// 窗口大小变化时重新调整图表
const handleResize = () => {
  chartInstance?.resize();
};

// 组件挂载
onMounted(() => {
  console.log("[ChinaMap] 组件已挂载");
  initChart();
  window.addEventListener("resize", handleResize);
});

// 组件卸载
onUnmounted(() => {
  console.log("[ChinaMap] 组件卸载，销毁图表实例");
  window.removeEventListener("resize", handleResize);
  chartInstance?.dispose();
  chartInstance = null;
});
</script>

<style scoped>
.china-map-container {
  position: relative;
  width: 100%;
  height: 500px;
  min-height: 400px;
  overflow: hidden;
}

.map-loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  min-height: 400px;
  color: #64748b;
}

.loading-spinner {
  width: 40px;
  height: 40px;
  border: 3px solid #e2e8f0;
  border-top: 3px solid #6366f1;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 12px;
}

@keyframes spin {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}

.chart {
  width: 100%;
  height: 500px;
  min-height: 400px;
  border-radius: 12px;
  background: #fafafa;
}

.map-legend {
  position: absolute;
  bottom: 16px;
  left: 16px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(8px);
  padding: 12px 16px;
  border-radius: 10px;
  border: 1px solid #e2e8f0;
  font-size: 12px;
  color: #64748b;
  z-index: 10;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 8px;
}

.legend-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
}

.legend-dot.visited {
  background: #10b981;
  box-shadow: 0 0 6px rgba(16, 185, 129, 0.5);
}

.legend-dot.active {
  background: #3b82f6;
  box-shadow: 0 0 6px rgba(59, 130, 246, 0.5);
}
</style>
